name: Health Check

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:
    # Allow manual triggering

jobs:
  health-check:
    name: Install Endpoint
    runs-on: ubuntu-latest
    steps:
      - name: Check endpoint
        run: |
          echo "Checking https://get.tsuku.dev/now..."

          # Fetch the endpoint and capture response
          HTTP_CODE=$(curl -s -o /tmp/response.txt -w "%{http_code}" https://get.tsuku.dev/now)

          # Check HTTP status code
          if [ "$HTTP_CODE" != "200" ]; then
            echo "ERROR: Expected HTTP 200, got $HTTP_CODE"
            exit 1
          fi
          echo "HTTP status: $HTTP_CODE"

          # Check response body is non-empty
          BODY_SIZE=$(stat -c%s /tmp/response.txt 2>/dev/null || stat -f%z /tmp/response.txt)
          if [ "$BODY_SIZE" -eq 0 ]; then
            echo "ERROR: Response body is empty"
            exit 1
          fi
          echo "Response size: $BODY_SIZE bytes"

          # Show first few lines of response
          echo "Response preview:"
          head -5 /tmp/response.txt

          echo ""
          echo "Health check passed!"
