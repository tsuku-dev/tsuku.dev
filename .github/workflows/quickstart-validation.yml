name: Quick Start Validation

on:
  push:
    branches: [main]
    paths:
      - 'index.html'
      - '.github/workflows/quickstart-validation.yml'
  pull_request:
    branches: [main]
    paths:
      - 'index.html'
      - '.github/workflows/quickstart-validation.yml'
  schedule:
    # Run daily at 06:00 UTC (offset from health-check at 00:00)
    - cron: '0 6 * * *'
  workflow_dispatch:
    # Allow manual triggering

jobs:
  validate-quickstart:
    name: Quick Start Examples
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install tsuku
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          bash install.sh --no-modify-path --no-telemetry
          source "$HOME/.tsuku/env"
          echo "$HOME/.tsuku/bin" >> $GITHUB_PATH
          echo "$HOME/.tsuku/tools/current" >> $GITHUB_PATH

      - name: Verify tsuku installed
        run: tsuku --version

      - name: "Test: tsuku install kubectl"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Running: tsuku install kubectl"
          OUTPUT=$(tsuku install kubectl 2>&1)
          echo "$OUTPUT"

          # Validate output patterns (version-agnostic)
          echo "$OUTPUT" | grep -q "Installed kubectl .* successfully" || {
            echo "ERROR: Expected 'Installed kubectl ... successfully' in output"
            exit 1
          }
          echo "Validation passed"

      - name: "Test: tsuku install terraform helm k6"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Running: tsuku install terraform helm k6"
          OUTPUT=$(tsuku install terraform helm k6 2>&1)
          echo "$OUTPUT"

          # Validate each tool was installed
          echo "$OUTPUT" | grep -q "Installed terraform .* successfully" || {
            echo "ERROR: Expected 'Installed terraform ... successfully' in output"
            exit 1
          }
          echo "$OUTPUT" | grep -q "Installed helm .* successfully" || {
            echo "ERROR: Expected 'Installed helm ... successfully' in output"
            exit 1
          }
          echo "$OUTPUT" | grep -q "Installed k6 .* successfully" || {
            echo "ERROR: Expected 'Installed k6 ... successfully' in output"
            exit 1
          }
          echo "Validation passed"

      - name: "Test: tsuku list"
        run: |
          echo "Running: tsuku list"
          OUTPUT=$(tsuku list 2>&1)
          echo "$OUTPUT"

          # Validate all installed tools appear in list
          echo "$OUTPUT" | grep -q "kubectl" || {
            echo "ERROR: Expected 'kubectl' in tsuku list output"
            exit 1
          }
          echo "$OUTPUT" | grep -q "terraform" || {
            echo "ERROR: Expected 'terraform' in tsuku list output"
            exit 1
          }
          echo "$OUTPUT" | grep -q "helm" || {
            echo "ERROR: Expected 'helm' in tsuku list output"
            exit 1
          }
          echo "$OUTPUT" | grep -q "k6" || {
            echo "ERROR: Expected 'k6' in tsuku list output"
            exit 1
          }
          echo "Validation passed"

      - name: "Test: Installed tools are executable"
        run: |
          echo "Verifying installed tools are executable..."

          kubectl version --client --output=yaml | head -5
          echo "kubectl: OK"

          terraform version | head -1
          echo "terraform: OK"

          helm version --short
          echo "helm: OK"

          k6 version
          echo "k6: OK"

          echo "All tools executable"
