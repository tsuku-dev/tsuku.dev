name: Quick Start Validation

on:
  push:
    branches: [main]
    paths:
      - 'index.html'
      - '.github/workflows/quickstart-validation.yml'
  pull_request:
    branches: [main]
    paths:
      - 'index.html'
      - '.github/workflows/quickstart-validation.yml'
  schedule:
    # Run daily at 06:00 UTC (offset from health-check at 00:00)
    - cron: '0 6 * * *'
  workflow_dispatch:
    # Allow manual triggering

jobs:
  validate-quickstart:
    name: Quick Start Examples
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install tsuku
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          bash install.sh --no-modify-path --no-telemetry
          source "$HOME/.tsuku/env"
          echo "$HOME/.tsuku/bin" >> $GITHUB_PATH
          echo "$HOME/.tsuku/tools/current" >> $GITHUB_PATH

      - name: Verify tsuku installed
        run: tsuku --version

      - name: "Test: tsuku install kubectl"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Running: tsuku install kubectl"
          echo "tsuku binary location: $(which tsuku)"
          echo "tsuku version: $(tsuku --version)"

          # Run with explicit error handling
          set +e
          tsuku install kubectl
          EXIT_CODE=$?
          set -e

          echo "Exit code: $EXIT_CODE"
          if [ $EXIT_CODE -ne 0 ]; then
            echo "ERROR: tsuku install kubectl failed with exit code $EXIT_CODE"
            exit 1
          fi

          echo "Validation passed"

      - name: "Test: tsuku install terraform helm k6"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Running: tsuku install terraform helm k6"

          set +e
          tsuku install terraform helm k6
          EXIT_CODE=$?
          set -e

          echo "Exit code: $EXIT_CODE"
          if [ $EXIT_CODE -ne 0 ]; then
            echo "ERROR: tsuku install terraform helm k6 failed with exit code $EXIT_CODE"
            exit 1
          fi

          echo "Validation passed"

      - name: "Test: tsuku list"
        run: |
          echo "Running: tsuku list"
          tsuku list
          echo "Validation passed"

      - name: "Test: Installed tools are executable"
        run: |
          echo "Verifying installed tools are executable..."

          kubectl version --client --output=yaml | head -5
          echo "kubectl: OK"

          terraform version | head -1
          echo "terraform: OK"

          helm version --short
          echo "helm: OK"

          k6 version
          echo "k6: OK"

          echo "All tools executable"
